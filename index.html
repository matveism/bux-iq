<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="description" content="Earn crypto, PayPal funds, and gift cards by completing offers and surveys" />
    <meta name="theme-color" content="#0a0a12" />
    <meta name="clckd" content="45663763f89113271aedcb23f063dab2" />
    <title>Bux IQ - Premium Rewards Platform</title>
    <link rel="icon" type="image/png" href="https://i.imgur.com/wppiqAy.png" />
    <link rel="apple-touch-icon" href="https://i.imgur.com/wppiqAy.png" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="Bux iQ" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        /* Space Themed Design */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Segoe UI", Tahoma, Arial, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #0a0a12 0%, #1a1a2e 50%, #16213e 100%);
            color: #ffffff;
            font-size: 14px;
            line-height: 1.4;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
            min-height: 100vh;
        }
        
        /* Header */
        .wm-header {
            background: linear-gradient(135deg, #0f3460 0%, #1a1a2e 100%);
            color: white;
            height: 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 8px;
            border-bottom: 1px solid #533483;
            font-weight: bold;
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 1000;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.5);
        }
        
        .wm-header .start {
            font-size: 16px;
            display: flex;
            align-items: center;
        }
        
        .wm-header .title {
            font-size: 16px;
            font-weight: bold;
            text-align: center;
            flex-grow: 1;
        }
        
        .wm-header .time {
            font-size: 14px;
        }
        
        /* Main Content */
        .wm-content {
            margin-top: 32px;
            margin-bottom: 52px;
            padding: 8px;
            min-height: calc(100vh - 84px);
        }
        
        /* Windows Mobile Tabs */
        .wm-tabs {
            display: flex;
            background: linear-gradient(135deg, #1a1a2e 0%, #0f3460 100%);
            border-bottom: 1px solid #533483;
            overflow-x: auto;
            border-radius: 8px 8px 0 0;
        }
        
        .wm-tab {
            padding: 8px 16px;
            background: linear-gradient(135deg, #533483 0%, #0f3460 100%);
            border: 1px solid #6a4c93;
            border-bottom: none;
            border-radius: 4px 4px 0 0;
            margin-right: 2px;
            color: white;
            font-weight: bold;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .wm-tab.active {
            background: linear-gradient(135deg, #6a4c93 0%, #533483 100%);
            color: #ffffff;
            box-shadow: 0 -2px 10px rgba(106, 76, 147, 0.5);
        }
        
        /* Content Sections */
        .wm-section {
            background: linear-gradient(135deg, rgba(26, 26, 46, 0.9) 0%, rgba(15, 52, 96, 0.9) 100%);
            border: 1px solid #533483;
            border-radius: 8px;
            padding: 12px;
            margin-top: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
        }
        
        .wm-section h2 {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 8px;
            color: #e94560;
            border-bottom: 1px solid #533483;
            padding-bottom: 4px;
        }
        
        /* Windows Mobile Buttons */
        .wm-button {
            background: linear-gradient(135deg, #e94560 0%, #c63650 100%);
            border: 1px solid #e94560;
            border-radius: 6px;
            padding: 8px 16px;
            font-size: 14px;
            color: #ffffff;
            cursor: pointer;
            margin: 4px 0;
            display: inline-block;
            text-align: center;
            transition: all 0.3s ease;
            font-weight: bold;
        }
        
        .wm-button:hover {
            background: linear-gradient(135deg, #c63650 0%, #e94560 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(233, 69, 96, 0.4);
        }
        
        .wm-button:active {
            transform: translateY(0);
        }
        
        .wm-button.primary {
            background: linear-gradient(135deg, #533483 0%, #6a4c93 100%);
            color: white;
            border-color: #6a4c93;
        }
        
        .wm-button.primary:hover {
            background: linear-gradient(135deg, #6a4c93 0%, #533483 100%);
            box-shadow: 0 4px 15px rgba(106, 76, 147, 0.4);
        }
        
        /* Google Login Button */
        .google-login-btn {
            background: linear-gradient(135deg, #4285f4 0%, #3367d6 100%);
            color: white;
            border: 1px solid #4285f4;
            border-radius: 6px;
            padding: 10px 16px;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            margin: 8px 0;
            transition: all 0.3s ease;
            font-weight: bold;
        }
        
        .google-login-btn i {
            margin-right: 8px;
            font-size: 16px;
        }
        
        .google-login-btn:hover {
            background: linear-gradient(135deg, #3367d6 0%, #4285f4 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(66, 133, 244, 0.4);
        }
        
        .divider {
            text-align: center;
            margin: 12px 0;
            color: #6a4c93;
            position: relative;
        }
        
        .divider::before {
            content: "";
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent 0%, #6a4c93 50%, transparent 100%);
            z-index: 1;
        }
        
        .divider span {
            background: linear-gradient(135deg, #1a1a2e 0%, #0f3460 100%);
            padding: 0 12px;
            position: relative;
            z-index: 2;
        }
        
        /* Input Fields */
        .wm-input {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid #533483;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 14px;
            width: 100%;
            margin: 6px 0;
            color: white;
            transition: all 0.3s ease;
        }
        
        .wm-input:focus {
            outline: none;
            border-color: #e94560;
            box-shadow: 0 0 10px rgba(233, 69, 96, 0.3);
        }
        
        .wm-input::placeholder {
            color: #a0a0a0;
        }
        
        /* List Items */
        .wm-list {
            background: rgba(26, 26, 46, 0.7);
            border: 1px solid #533483;
            border-radius: 6px;
            overflow: hidden;
            margin: 8px 0;
        }
        
        .wm-list-item {
            padding: 10px 12px;
            border-bottom: 1px solid #533483;
            display: flex;
            align-items: center;
            transition: background 0.3s ease;
        }
        
        .wm-list-item:hover {
            background: rgba(83, 52, 131, 0.3);
        }
        
        .wm-list-item:last-child {
            border-bottom: none;
        }
        
        .wm-list-item .icon {
            width: 28px;
            height: 28px;
            margin-right: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #e94560 0%, #c63650 100%);
            color: white;
            border-radius: 6px;
            font-size: 12px;
        }
        
        /* Footer Navigation */
        .wm-footer {
            background: linear-gradient(135deg, #0f3460 0%, #1a1a2e 100%);
            height: 52px;
            position: fixed;
            bottom: 0;
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 8px;
            border-top: 1px solid #533483;
            z-index: 1000;
            box-shadow: 0 -2px 20px rgba(0, 0, 0, 0.5);
        }
        
        .wm-footer-button {
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            width: 64px;
            height: 42px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 6px;
        }
        
        .wm-footer-button i {
            font-size: 16px;
            margin-bottom: 2px;
        }
        
        .wm-footer-button.active {
            background: linear-gradient(135deg, #e94560 0%, #c63650 100%);
            box-shadow: 0 2px 10px rgba(233, 69, 96, 0.4);
        }
        
        .wm-footer-button:hover {
            background: rgba(233, 69, 96, 0.3);
        }
        
        /* Status Bar */
        .wm-status-bar {
            background: linear-gradient(135deg, #533483 0%, #0f3460 100%);
            color: white;
            padding: 8px 12px;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
            border: 1px solid #6a4c93;
            border-radius: 6px;
            margin-top: 8px;
        }
        
        /* Hidden sections */
        .hidden {
            display: none !important;
        }
        
        /* Logs Section */
        .wm-logs {
            background: rgba(26, 26, 46, 0.7);
            border: 1px solid #533483;
            border-radius: 6px;
            height: 120px;
            overflow-y: auto;
            padding: 8px;
            font-family: "Courier New", monospace;
            font-size: 12px;
            margin: 8px 0;
        }
        
        /* Login Form */
        .wm-login-form {
            background: rgba(26, 26, 46, 0.7);
            border: 1px solid #533483;
            border-radius: 6px;
            padding: 16px;
            margin: 8px 0;
        }
        
        .wm-login-form label {
            display: block;
            margin-bottom: 6px;
            font-weight: bold;
            color: #e94560;
        }
        
        /* CAPTCHA */
        .wm-captcha {
            background: linear-gradient(135deg, #533483 0%, #6a4c93 100%);
            border: 1px solid #6a4c93;
            border-radius: 6px;
            padding: 12px;
            text-align: center;
            font-family: "Courier New", monospace;
            font-size: 20px;
            font-weight: bold;
            letter-spacing: 3px;
            margin: 8px 0;
            color: white;
        }
        
        /* Offer Wall Grid */
        .wm-offer-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 8px 0;
        }
        
        .wm-offer-item {
            background: rgba(26, 26, 46, 0.7);
            border: 1px solid #533483;
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .wm-offer-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(106, 76, 147, 0.4);
        }
        
        .wm-offer-item img {
            max-width: 100%;
            height: 40px;
            object-fit: contain;
            margin-bottom: 8px;
        }
        
        /* Leaderboard */
        .wm-leaderboard {
            background: rgba(26, 26, 46, 0.7);
            border: 1px solid #533483;
            border-radius: 6px;
            overflow: hidden;
            margin: 8px 0;
        }
        
        .wm-leaderboard table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .wm-leaderboard th {
            background: linear-gradient(135deg, #533483 0%, #0f3460 100%);
            color: white;
            padding: 8px 10px;
            text-align: left;
            font-weight: bold;
            border-right: 1px solid #6a4c93;
        }
        
        .wm-leaderboard th:last-child {
            border-right: none;
        }
        
        .wm-leaderboard td {
            padding: 8px 10px;
            border-bottom: 1px solid #533483;
        }
        
        .wm-leaderboard tr:last-child td {
            border-bottom: none;
        }
        
        .wm-leaderboard tr:hover {
            background: rgba(83, 52, 131, 0.3);
        }
        
        /* FAQ Items */
        .wm-faq-item {
            background: rgba(26, 26, 46, 0.7);
            border: 1px solid #533483;
            border-radius: 6px;
            padding: 12px;
            margin: 8px 0;
            transition: all 0.3s ease;
        }
        
        .wm-faq-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        
        .wm-faq-item h4 {
            color: #e94560;
            margin-bottom: 6px;
            font-weight: bold;
        }
        
        /* Iframe Container */
        .wm-iframe-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0a0a12 0%, #1a1a2e 100%);
            z-index: 2000;
            display: none;
        }
        
        .wm-iframe-header {
            background: linear-gradient(135deg, #0f3460 0%, #1a1a2e 100%);
            color: white;
            height: 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 8px;
            border-bottom: 1px solid #533483;
        }
        
        .wm-iframe-content {
            height: calc(100% - 32px);
        }
        
        .wm-iframe-content iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        
        /* User Info */
        .wm-user-info {
            background: rgba(26, 26, 46, 0.7);
            border: 1px solid #533483;
            border-radius: 8px;
            padding: 12px;
            margin: 8px 0;
            display: flex;
            align-items: center;
        }
        
        .wm-user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            margin-right: 12px;
            border: 2px solid #e94560;
        }
        
        .wm-user-details {
            flex-grow: 1;
        }
        
        .wm-user-stats {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
        }
        
        .wm-stat {
            text-align: center;
            flex: 1;
        }
        
        .wm-stat-value {
            font-weight: bold;
            font-size: 18px;
            color: #e94560;
        }
        
        .wm-stat-label {
            font-size: 10px;
            color: #a0a0a0;
        }
        
        /* Bonus Section Styles */
        .bonus-code-section {
            background: linear-gradient(135deg, rgba(26, 26, 46, 0.9) 0%, rgba(15, 52, 96, 0.9) 100%);
            border: 1px solid #533483;
            border-radius: 8px;
            padding: 12px;
            margin-top: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
        }
        
        .info-box {
            background: linear-gradient(135deg, rgba(233, 69, 96, 0.2) 0%, rgba(198, 54, 80, 0.2) 100%);
            border: 1px solid #e94560;
            border-radius: 6px;
            padding: 12px;
            margin: 8px 0;
            display: flex;
            align-items: flex-start;
        }
        
        .info-box i {
            color: #e94560;
            margin-right: 10px;
            margin-top: 2px;
        }
        
        .bonus-form {
            background: rgba(26, 26, 46, 0.7);
            border: 1px solid #533483;
            border-radius: 6px;
            padding: 16px;
            margin: 8px 0;
        }
        
        .form-group {
            margin-bottom: 12px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: bold;
            color: #e94560;
        }
        
        .form-row {
            display: flex;
            gap: 10px;
        }
        
        .form-row .form-group {
            flex: 1;
        }

        /* Error Message */
        .error-message {
            background: linear-gradient(135deg, rgba(233, 69, 96, 0.2) 0%, rgba(198, 54, 80, 0.2) 100%);
            border: 1px solid #e94560;
            border-radius: 6px;
            padding: 10px;
            margin: 8px 0;
            text-align: center;
            color: #e94560;
            font-weight: bold;
        }

        /* Stars Background Effect */
        .stars {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }

        .star {
            position: absolute;
            background: white;
            border-radius: 50%;
            animation: twinkle 5s infinite;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.2; }
            50% { opacity: 1; }
        }
    </style>
</head>
<body>
    <!-- Stars Background -->
    <div class="stars" id="stars"></div>
    
    <!-- Windows Mobile Header -->
    <div class="wm-header">
        <div class="start">Start</div>
        <div class="title">Bux iQ</div>
        <div class="time" id="headerTime">12:00 PM</div>
    </div>
    
    <!-- Main Content -->
    <div class="wm-content">
        <!-- Tabs -->
        <div class="wm-tabs">
            <div class="wm-tab active" data-section="earn">Home</div>
            <div class="wm-tab" data-section="shop">Shop</div>
            <div class="wm-tab" data-section="leaders">Leaders</div>
            <div class="wm-tab" data-section="profile">Earn</div>
            <div class="wm-tab" data-section="bonus">Bonus</div>
            <div class="wm-tab" data-section="help">Help</div>
        </div>
        
        <!-- Status Bar -->
        <div class="wm-status-bar">
            <center><div>$1 . 00 => 1 pts</div></center>
            <div id="serverTime">Server Time: 00:00:00</div>
        </div>
        
        <!-- Home Section -->
        <div id="section-earn" class="wm-section">
            <h2>Welcome to Bux iQ</h2>
            
            <div class="wm-logs" id="logs">
                <div class="wm-list-item">
                    <div class="icon"><i class="fas fa-info-circle"></i></div>
                    <div>Your activity log will appear here</div>
                </div>
            </div>
            
            <div class="wm-user-info" id="userInfo">
                <img src="https://ui-avatars.com/api/?background=e94560&color=fff&name=Guest&bold=true" class="wm-user-avatar" id="userAvatar" alt="User Avatar">
                <div class="wm-user-details">
                    <div id="userName">Guest User</div>
                    <div class="wm-user-stats">
                        <div class="wm-stat">
                            <div class="wm-stat-value" id="userBalance">$0.00</div>
                            <div class="wm-stat-label">Balance</div>
                        </div>
                        <div class="wm-stat">
                            <div class="wm-stat-value" id="userLevel">0</div>
                            <div class="wm-stat-label">Level</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="wm-button primary" style="width: 100%;" id="loginButton">Login to Earn</div>
            
            <h2>How It Works</h2>
            <div class="wm-list">
                <div class="wm-list-item">
                    <div class="icon"><i class="fas fa-tasks"></i></div>
                    <div>Complete Surveys</div>
                </div>
                <div class="wm-list-item">
                    <div class="icon"><i class="fas fa-star"></i></div>
                    <div>Earn Stars</div>
                </div>
                <div class="wm-list-item">
                    <div class="icon"><i class="fas fa-gift"></i></div>
                    <div>Redeem Rewards</div>
                </div>
            </div>
            
            <h2>Cashout Options</h2>
            <div class="wm-list">
                <div class="wm-list-item">
                    <div class="icon"><i class="fab fa-amazon"></i></div>
                    <div>Amazon UK Voucher</div>
                </div>
                <div class="wm-list-item">
                    <div class="icon"><i class="fab fa-bitcoin"></i></div>
                    <div>LTC Crypto</div>
                </div>
                <div class="wm-list-item">
                    <div class="icon"><i class="fas fa-plus"></i></div>
                    <div>More Coming Soon!</div>
                </div>
            </div>
        </div>
        
        <!-- Shop Section -->
        <div id="section-shop" class="wm-section hidden">
            <h2>Shop Rewards</h2>
            <div class="wm-offer-grid">
                <div class="wm-offer-item">
                    <img src="https://i.imgur.com/3CUrxKO.png" alt="BUXiQ Logo">
                    <div class="wm-button primary" id="openOfferWallbuxiq">Cashout</div>
                </div>
            </div>
        </div>
        
        <!-- Leaders Section -->
        <div id="section-leaders" class="wm-section hidden">
            <h2>Leaderboard</h2>
            <div class="wm-leaderboard">
                <table>
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Username</th>
                            <th>Earnings</th>
                            <th>Level</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboardBody">
                        <tr>
                            <td>1</td>
                            <td>Loading...</td>
                            <td>$0.00</td>
                            <td>0</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Profile/Earn Section -->
        <div id="section-profile" class="wm-section hidden">
            <div id="login-container">
                <h2>Login</h2>
                
                <!-- Google Login Button -->
                <div id="g_id_onload"
                    data-client_id="387422659555-007kjhq0c41f2lq39e075ib5mtpf3q9o.apps.googleusercontent.com"
                    data-context="signin"
                    data-ux_mode="popup"
                    data-callback="handleGoogleCredentialResponse"
                    data-auto_prompt="false">
                </div>

                <div class="g_id_signin google-login-btn" 
                     data-type="standard" 
                     data-theme="filled_blue" 
                     data-text="signin_with" 
                     data-shape="rectangular" 
                     data-logo_alignment="left">
                </div>
                
                <div class="divider">
                    <span>OR</span>
                </div>
                
                <!-- Manual Login -->
                <div class="wm-login-form">
                    <label for="login-account">Account #</label>
                    <input type="text" id="login-account" class="wm-input" placeholder="Enter your account number">
                    
                    <label for="login-clientid">Client ID</label>
                    <input type="text" id="login-clientid" class="wm-input" placeholder="Enter your client ID">
                    
                    <label>CAPTCHA</label>
                    <div class="wm-captcha" id="captcha"></div>
                    <input type="text" id="captchaInput" class="wm-input" placeholder="Enter CAPTCHA">
                    
                    <div class="wm-button primary" style="width: 100%;" id="loginFormButton">Login</div>
                </div>
                <div id="error-msg" class="error-message hidden"></div>
            </div>
            
            <div id="dashboard" class="hidden">
                <h2>Earning Portal</h2>
                <p style="margin-bottom: 12px; text-align: center;">Complete offers and surveys to earn rewards</p>
                
                <div class="wm-offer-grid" id="offerwall-grid">
                    <div class="wm-offer-item">
                        <img src="https://www.cpx-research.com/main/en/assets/img/logo.svg" alt="CPX Research Logo">
                        <div class="wm-button primary" id="openOfferWallCPX">Open OfferWall</div>
                    </div>
                    <div class="wm-offer-item">
                        <img src="https://www.spark-wall.com/images/logo.png" alt="SparWall Logo">
                        <div class="wm-button primary" id="openOfferWallSPARKWALL">Open OfferWall</div>
                    </div>
                    <div class="wm-offer-item">
                        <img src="https://offerwallmedia.com/assets/cwdash/img/logo.png" alt="BUXiQ Logo">
                        <div class="wm-button primary" id="openOfferWallowm">Open OfferWall</div>
                    </div>
                </div>
                
                <div class="wm-button" style="width: 100%; margin-top: 12px;" id="logoutBtn">Logout</div>
            </div>
        </div>
        
        <!-- Bonus Section -->
        <div id="section-bonus" class="bonus-code-section hidden">
            <h2>Redeem Bonus Code</h2>
            
            <div class="info-box">
                <i class="fas fa-exclamation-triangle"></i>
                <div>WHO FIRST REDEEMED HIS/HER PTS! EACH BONUS CODE WILL BE MARKED AS UNUSED - FIRST COME FIRST SERVED!!!</div>
            </div>
            
            <form class="bonus-form" id="redeemForm">
                <div class="form-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" class="wm-input" required placeholder="Enter your username">
                </div>
                
                <div class="form-group">
                    <label for="bonusCode">Bonus Code</label>
                    <input type="text" id="bonusCode" class="wm-input" required placeholder="Enter bonus code">
                </div>
                
                <button type="button" class="wm-button primary" id="redeemBonusButton">Redeem Bonus Code</button>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="amountLocal">Amount (Local)</label>
                        <input type="text" id="amountLocal" class="wm-input" readonly placeholder="0">
                    </div>
                    
                    <div class="form-group">
                        <label for="amountUsd">Amount (USD)</label>
                        <input type="text" id="amountUsd" class="wm-input" readonly placeholder="$0.00">
                    </div>
                </div>
            </form>
        </div>
        
        <!-- Help Section -->
        <div id="section-help" class="wm-section hidden">
            <h2>Help & Support</h2>
            
            <div class="wm-faq-item">
                <h4>How do I earn points?</h4>
                <p>1. IF YOU DID NOT LOGGED IN YET LOGIN FIRST AND THEN EITHER CLICK LOGIN TO EARN IF YOU ARE IN THE HOME PAGE.</p>
                <p>2. CLICK EITHER TAB ABOVE, EITHER BELOW, BUTTON or TAB EARN.</p>
                <p>3. YOU ALL SEE OFFERWALLS AND YOU CLICK ON THEM DO OFFERS OR SURVEYS!</p>
            </div>
            
            <div class="wm-faq-item">
                <h4>How can I redeem rewards?</h4>
                <p>YOU MAY CLICK EITHER ABOVE, OR, BELOW TAB OR BUTTON "SHOP".</p>
            </div>
            
            <div class="wm-faq-item">
                <h4>HOW TO REDEEM BONUS CODE?</h4>
                <p>CLICK TAB OR BUTTON<strong> BONUS</strong> YOU MUST FILL OUT A FORM PUT YOUR ACCOUNT# AND ENTER BONUS CODE.</p>
            </div>
            
            <div class="wm-faq-item">
                <h4>Who do I contact for support?</h4>
                <p>Our ADMIN is available from 10 am - 5 pm PST. Click the button below to contact us.</p>
            </div>
            
            <div class="wm-button primary" style="width: 100%;" id="contact-support-btn">Contact Support</div>
        </div>
    </div>
    
    <!-- Footer Navigation -->
    <div class="wm-footer">
        <div class="wm-footer-button active" data-section="earn">
            <i class="fas fa-home"></i>
            <span>Home</span>
        </div>
        <div class="wm-footer-button" data-section="shop">
            <i class="fas fa-shopping-bag"></i>
            <span>Shop</span>
        </div>
        <div class="wm-footer-button" data-section="leaders">
            <i class="fas fa-trophy"></i>
            <span>Leaders</span>
        </div>
        <div class="wm-footer-button" data-section="profile">
            <i class="fas fa-money-bill-wave"></i>
            <span>Earn</span>
        </div>
        <div class="wm-footer-button" data-section="bonus">
            <i class="fas fa-star"></i>
            <span>BONUS</span>
        </div>
        <div class="wm-footer-button" data-section="help">
            <i class="fas fa-question-circle"></i>
            <span>Help</span>
        </div>
    </div>
    
    <!-- Iframe Container -->
    <div class="wm-iframe-container" id="iframeContainer">
        <div class="wm-iframe-header">
            <div>Offer Wall</div>
            <div class="wm-button" id="closeIframe">Close</div>
        </div>
        <div class="wm-iframe-content">
            <iframe id="dashboardIframe" src=""></iframe>
        </div>
    </div>
    
    <script>
// Global variables
let captchaCode = '';
let currentUser = null;

// Google Apps Script URL for posting data to Google Sheets
const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxLwW7NEXLMSDPh1A_PJbTjAucIuji6JtsgVu2xAdaMzXthTKsgk2xyWy83Dx8dO53Rrg/exec';

// DOM Content Loaded - Initialize everything
document.addEventListener('DOMContentLoaded', function() {
    // Generate initial CAPTCHA
    generateCaptcha();

    // Check for existing session
    checkExistingSession();

    // Initialize all event listeners
    initializeEventListeners();

    // Start server time updates
    updateServerTime();
    setInterval(updateServerTime, 1000);
    
    // Update header time
    updateHeaderTime();
    setInterval(updateHeaderTime, 60000);
    
    // Load activity logs
    fetchCSV();
    
    // Load leaderboard
    loadLeaderboard();
    
    // Create stars background
    createStars();
});

// Create stars background
function createStars() {
    const starsContainer = document.getElementById('stars');
    for (let i = 0; i < 100; i++) {
        const star = document.createElement('div');
        star.className = 'star';
        star.style.width = Math.random() * 2 + 'px';
        star.style.height = star.style.width;
        star.style.left = Math.random() * 100 + '%';
        star.style.top = Math.random() * 100 + '%';
        star.style.animationDelay = Math.random() * 5 + 's';
        starsContainer.appendChild(star);
    }
}

// Initialize all event listeners
function initializeEventListeners() {
    // Tab click handlers
    document.querySelectorAll('.wm-tab').forEach(tab => {
        tab.addEventListener('click', e => {
            e.preventDefault();
            showSection(tab.dataset.section);
            
            // Update active tab
            document.querySelectorAll('.wm-tab').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
        });
    });

    // Footer navigation handlers
    document.querySelectorAll('.wm-footer-button').forEach(button => {
        button.addEventListener('click', e => {
            e.preventDefault();
            showSection(button.dataset.section);
            
            // Update active footer button
            document.querySelectorAll('.wm-footer-button').forEach(b => b.classList.remove('active'));
            button.classList.add('active');
        });
    });

    // Login button
    document.getElementById('loginButton')?.addEventListener('click', () => {
        showSection('profile');
        document.querySelectorAll('.wm-tab').forEach(t => t.classList.remove('active'));
        document.querySelector('.wm-tab[data-section="profile"]').classList.add('active');
        document.querySelectorAll('.wm-footer-button').forEach(b => b.classList.remove('active'));
        document.querySelector('.wm-footer-button[data-section="profile"]').classList.add('active');
    });

    // Login form handler
    document.getElementById('loginFormButton')?.addEventListener('click', handleLogin);

    // Iframe close button
    document.getElementById('closeIframe')?.addEventListener('click', closeIframe);

    // Logout button
    document.getElementById('logoutBtn')?.addEventListener('click', logout);

    // Contact support button
    document.getElementById('contact-support-btn')?.addEventListener('click', () => {
        alert('Please email support@buxiq.com for assistance.');
    });

    // Bonus redeem button
    document.getElementById('redeemBonusButton')?.addEventListener('click', redeemBonusCode);

    // Initialize offerwall buttons
    initializeOfferwallButtons();
}

// Initialize offerwall buttons with user validation
function initializeOfferwallButtons() {
    Object.keys(offerwallButtons).forEach(buttonId => {
        const button = document.getElementById(buttonId);
        if (button) {
            // Remove any existing listeners to prevent duplicates
            button.removeEventListener('click', offerwallClickHandler);
            // Add new listener
            button.addEventListener('click', offerwallClickHandler);
        }
    });
}

// Handler for offerwall button clicks
function offerwallClickHandler(e) {
    e.preventDefault();

    if (!currentUser) {
        alert('Please login first to access offerwalls');
        showSection('profile');
        return;
    }

    const buttonId = this.id;
    const urlGenerator = offerwallButtons[buttonId];

    if (!urlGenerator) {
        console.error('No URL generator found for button:', buttonId);
        return;
    }

    // Use user[4] (username) or user[0] (account) as fallback
    const username = currentUser[4] || currentUser[0] || 'user';
    const url = typeof urlGenerator === 'function' ? urlGenerator(username) : urlGenerator;

    console.log(`Opening offerwall ${buttonId} for user ${username}`);
    openIframe(url);
}

// Enhanced iframe functions
function openIframe(url) {
    const iframeContainer = document.getElementById('iframeContainer');
    const dashboardIframe = document.getElementById('dashboardIframe');

    if (!iframeContainer || !dashboardIframe) {
        console.error('Iframe elements not found');
        return;
    }

    dashboardIframe.src = url;
    iframeContainer.style.display = 'block';
}

function closeIframe() {
    const iframeContainer = document.getElementById('iframeContainer');
    const dashboardIframe = document.getElementById('dashboardIframe');

    if (iframeContainer && dashboardIframe) {
        iframeContainer.style.display = 'none';
        dashboardIframe.src = '';
    }
}

// Update server time display
function updateServerTime() {
    const now = new Date();

    // Convert to PST (UTC-8) or PDT (UTC-7) depending on daylight saving
    const pstOffset = now.getTimezoneOffset() >= 480 ? -8 * 60 : -7 * 60; // PST is UTC-8, PDT is UTC-7
    const pstTime = new Date(now.getTime() + (now.getTimezoneOffset() - pstOffset) * 60000);

    // Format as HH:MM:SS
    const hours = String(pstTime.getHours()).padStart(2, '0');
    const minutes = String(pstTime.getMinutes()).padStart(2, '0');
    const seconds = String(pstTime.getSeconds()).padStart(2, '0');

    document.getElementById('serverTime').textContent = `Server Time: ${hours}:${minutes}:${seconds} PST`;
}

// Update header time
function updateHeaderTime() {
    const now = new Date();
    const hours = now.getHours();
    const minutes = String(now.getMinutes()).padStart(2, '0');
    const ampm = hours >= 12 ? 'PM' : 'AM';
    const displayHours = hours % 12 || 12;
    
    document.getElementById('headerTime').textContent = `${displayHours}:${minutes} ${ampm}`;
}

// Object with offerwall URLs and open functions
const offerwallButtons = {
    'openOfferWallCPX': (user) => `https://offers.cpx-research.com/index.php?app_id=26219&ext_user_id=${user}&username=${user}&subid_1=&subid_2`,
    'openOfferWallSPARKWALL': (user) => `https://spark-wall.com/offerwall/G2kA8XaPF2jjstApSCZsK6aE6qudMN/${user}&username=${user}&subid_1=&subid_2`,
    'openOfferWallowm': (user) => `https://offerwallmedia.com/offerwall/vfox4w1tpz3gflta3gblkkqp8b2aoj/${user}`,
    'openOfferWallbuxiq': () => `https://bux-iq.netlify.app/cashout.html`
};

// Check for existing user session
function checkExistingSession() {
    const savedAccount = localStorage.getItem('buxiq_account');
    const savedGoogleUser = localStorage.getItem('buxiq_google_user');
    
    if (savedGoogleUser) {
        // Handle Google user session restoration with blocked check
        checkAndRestoreGoogleSession(savedGoogleUser);
    } else if (savedAccount) {
        // Handle manual login session restoration
        restoreManualSession(savedAccount);
    } else {
        // Show default section if no session
        showSection('earn');
    }
}

// Check and restore Google session with blocked validation
async function checkAndRestoreGoogleSession(savedGoogleUser) {
    try {
        const googleUser = JSON.parse(savedGoogleUser);
        
        // Check if user still exists and is not blocked
        const response = await fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vQHuo-I6k4RbAnXvz_FvCzshqg7Cm5dqAXwNkvDLpgpZH84OGUSbX6TiOUfMrCHv3CiNnLnx0IhzNZC/pub?gid=0&single=true&output=csv');
        if (!response.ok) throw new Error('Network response was not ok');

        const data = await response.text();
        const rows = data.trim().split('\n').map(row => row.split(','));

        // Find user by Google ID or email
        const user = rows.find(r => r[7] === googleUser.id || r[8] === googleUser.email);

        if (user) {
            // Check if user is blocked
            const status = (user[2] || '').toLowerCase();
            if (status === 'blocked') {
                // Clear blocked user session
                localStorage.removeItem('buxiq_google_user');
                showSection('earn');
                return;
            }
            
            // User is valid, restore session
            simulateGoogleLoginRestore(googleUser);
        } else {
            // User not found in database, clear session
            localStorage.removeItem('buxiq_google_user');
        }
    } catch (err) {
        console.error('Error checking Google session:', err);
        // On error, clear session to be safe
        localStorage.removeItem('buxiq_google_user');
    }
}

// Restore manual session
async function restoreManualSession(account) {
    try {
        const response = await fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vQHuo-I6k4RbAnXvz_FvCzshqg7Cm5dqAXwNkvDLpgpZH84OGUSbX6TiOUfMrCHv3CiNnLnx0IhzNZC/pub?gid=0&single=true&output=csv');
        if (!response.ok) throw new Error('Network response was not ok');

        const data = await response.text();
        const rows = data.trim().split('\n').map(row => row.split(','));

        // Find user by account number
        const user = rows.find(r => r[0] === account);

        if (user) {
            // Check if user is blocked
            const status = (user[2] || '').toLowerCase();
            if (status === 'blocked') {
                // Clear blocked user session
                localStorage.removeItem('buxiq_account');
                return;
            }
            
            currentUser = user;
            updateUserUI(user);
            
            // Show dashboard
            document.getElementById('login-container').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            
            // Update balance
            await updateBalance();
            
            addToLogs(`Session restored for ${user[4] || 'User'}`);
        } else {
            // Clear invalid session
            localStorage.removeItem('buxiq_account');
        }
    } catch (err) {
        console.error('Error restoring session:', err);
    }
}

// Simulate Google login restore
function simulateGoogleLoginRestore(googleUser) {
    const simulatedUser = {
        email: googleUser.email,
        name: googleUser.name,
        id: googleUser.id,
        picture: googleUser.picture
    };
    processGoogleLogin(simulatedUser);
}

// Handle Google Sign-In response
function handleGoogleCredentialResponse(response) {
    console.log("Google Sign-In response:", response);
    
    // Decode the JWT token to get user info
    const responsePayload = parseJwt(response.credential);
    
    console.log("Google user info:", responsePayload);
    
    // Process Google login with the user info
    processGoogleLogin({
        id: responsePayload.sub,
        email: responsePayload.email,
        name: responsePayload.name,
        picture: responsePayload.picture
    });
}

// Parse JWT token
function parseJwt(token) {
    try {
        const base64Url = token.split('.')[1];
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
            return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));
        
        return JSON.parse(jsonPayload);
    } catch (e) {
        console.error("Error parsing JWT:", e);
        return null;
    }
}

// Process Google Login
async function processGoogleLogin(googleUser) {
    const errorMsg = document.getElementById('error-msg');
    
    try {
        // Check if user exists in Google Sheets
        const response = await fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vQHuo-I6k4RbAnXvz_FvCzshqg7Cm5dqAXwNkvDLpgpZH84OGUSbX6TiOUfMrCHv3CiNnLnx0IhzNZC/pub?gid=0&single=true&output=csv');
        if (!response.ok) throw new Error('Network response was not ok');

        const data = await response.text();
        const rows = data.trim().split('\n').map(row => row.split(','));

        // Look for user by Google ID or email
        const user = rows.find(r => r[7] === googleUser.id || r[8] === googleUser.email);

        if (user) {
            // Check if user is blocked
            const status = (user[2] || '').toLowerCase();
            if (status === 'blocked') {
                showError(errorMsg, 'Your account is blocked.');
                // Clear any stored Google session data
                localStorage.removeItem('buxiq_google_user');
                return;
            }

            // Existing user - login
            currentUser = user;
            await completeLogin(user);
            
            // Store session for Google user
            localStorage.setItem('buxiq_google_user', JSON.stringify({
                id: googleUser.id,
                email: googleUser.email,
                name: googleUser.name,
                picture: googleUser.picture
            }));
        } else {
            // New user - auto-register
            await registerGoogleUser(googleUser);
        }
    } catch (err) {
        console.error('Google login processing error:', err);
        showError(errorMsg, 'Error during Google login. Please try again.');
    }
}

// Register new Google user
async function registerGoogleUser(googleUser) {
    // Generate unique account number and client ID
    const accountNumber = 'G' + Math.random().toString(36).substr(2, 8).toUpperCase();
    const clientId = 'GC' + Math.random().toString(36).substr(2, 6).toUpperCase();
    
    // Create new user data
    const newUser = [
        accountNumber,      // 0: Account #
        clientId,          // 1: Client ID
        'active',          // 2: Status
        '0.00',           // 3: Balance
        googleUser.name,   // 4: Username
        googleUser.picture, // 5: Avatar URL (Google profile picture)
        '1',              // 6: Level
        googleUser.id,    // 7: Google ID
        googleUser.email  // 8: Google Email
    ];
    
    // Post new user to Google Sheets
    await postUserToSheets(newUser);
    
    // In a real implementation, you would send this to your backend/Google Apps Script
    // For now, we'll use the new user data directly
    currentUser = newUser;
    
    // Store in localStorage
    localStorage.setItem('buxiq_google_user', JSON.stringify({
        id: googleUser.id,
        email: googleUser.email,
        name: googleUser.name,
        picture: googleUser.picture,
        account: accountNumber,
        clientId: clientId
    }));
    
    await completeLogin(newUser);
    
    // Show welcome message for new users
    addToLogs(`Welcome ${googleUser.name}! Your account has been created.`);
}

// Post user data to Google Sheets
async function postUserToSheets(userData) {
    try {
        // Prepare data for Google Sheets
        const formData = new FormData();
        formData.append('action', 'addUser');
        formData.append('account', userData[0]);
        formData.append('clientId', userData[1]);
        formData.append('status', userData[2]);
        formData.append('balance', userData[3]);
        formData.append('username', userData[4]);
        formData.append('avatar', userData[5]);
        formData.append('level', userData[6]);
        formData.append('googleId', userData[7]);
        formData.append('googleEmail', userData[8]);
        
        // Send POST request to Google Apps Script
        const response = await fetch(GOOGLE_SCRIPT_URL, {
            method: 'POST',
            body: formData
        });
        
        if (response.ok) {
            console.log('User data successfully posted to Google Sheets');
            return true;
        } else {
            console.error('Failed to post user data to Google Sheets');
            return false;
        }
    } catch (error) {
        console.error('Error posting user data to Google Sheets:', error);
        return false;
    }
}

// Login handler
async function handleLogin(e) {
    e.preventDefault();

    const account = document.getElementById('login-account')?.value?.trim() || '';
    const clientid = document.getElementById('login-clientid')?.value?.trim() || '';
    const captchaInput = document.getElementById('captchaInput')?.value?.trim() || '';
    const errorMsg = document.getElementById('error-msg');

    // For auto-login, allow a temporary bypass for CAPTCHA verification
    const isAutoLogin = e.type === 'auto';
    if (!isAutoLogin && captchaInput !== captchaCode) {
        showError(errorMsg, 'Invalid CAPTCHA');
        generateCaptcha();
        document.getElementById('captchaInput').value = '';
        return;
    }

    try {
        const response = await fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vQHuo-I6k4RbAnXvz_FvCzshqg7Cm5dqAXwNkvDLpgpZH84OGUSbX6TiOUfMrCHv3CiNnLnx0IhzNZC/pub?gid=0&single=true&output=csv');
        if (!response.ok) throw new Error('Network response was not ok');

        const data = await response.text();
        const rows = data.trim().split('\n').map(row => row.split(','));

        // Find user in spreadsheet data based on account and clientid (if not auto-login)
        const user = rows.find(r => r[0] === account && (isAutoLogin || r[1] === clientid));

        if (user) {
            const status = (user[2] || '').toLowerCase();
            if (status === 'blocked') {
                showError(errorMsg, 'Your account is blocked.');
                // Clear login fields and generate new CAPTCHA on blocked account
                document.getElementById('login-account').value = '';
                document.getElementById('login-clientid').value = '';
                document.getElementById('captchaInput').value = '';
                generateCaptcha();
                return;
            }

            // Store current user globally
            currentUser = user;

            // Store in local storage
            localStorage.setItem('buxiq_account', account);

            // Update UI with user data
            updateUserUI(user);

            // Show dashboard
            document.getElementById('login-container')?.classList.add('hidden');
            document.getElementById('dashboard')?.classList.remove('hidden');
            if (errorMsg) errorMsg.classList.add('hidden');

            // Initialize offerwalls for this user
            initializeOfferwallButtons();

            // Load additional data
            fetchCSV(); // For activity logs
            updateBalance(); // Update balance immediately after login
            
            addToLogs(`Login successful for ${user[4] || 'User'}`);
        } else {
            showError(errorMsg, 'Invalid credentials');
            // Clear CAPTCHA input and generate new CAPTCHA on invalid credentials
            document.getElementById('captchaInput').value = '';
            generateCaptcha();
        }
    } catch (err) {
        console.error('Login error:', err);
        showError(errorMsg, 'Error loading data. Please try again.');
        // Clear CAPTCHA input and generate new CAPTCHA on error
        document.getElementById('captchaInput').value = '';
        generateCaptcha();
    } finally {
        // Ensure captchaInput is cleared if it was a temporary auto-login value
        if (isAutoLogin && document.getElementById('captchaInput').value === 'auto_login_temp') {
            document.getElementById('captchaInput').value = '';
        }
    }
}

// Complete login process for both manual and Google login
async function completeLogin(user) {
    // Update user data
    const avatarUrl = user[5] || `https://ui-avatars.com/api/?name=${encodeURIComponent(user[4] || 'User')}&background=e94560&color=fff`;
    
    // Update UI
    document.getElementById('userAvatar').src = avatarUrl;
    document.getElementById('userName').textContent = user[4] || 'User';
    
    // Show dashboard
    document.getElementById('login-container').classList.add('hidden');
    document.getElementById('dashboard').classList.remove('hidden');
    document.getElementById('error-msg').classList.add('hidden');
    
    // Update balance and level
    await updateBalance();
    
    // Add login success message
    addToLogs(`Login successful for ${user[4] || 'User'}`);
}

// Helper function to show errors
function showError(element, message) {
    if (element) {
        element.textContent = message;
        element.classList.remove('hidden');
    } else {
        alert(message);
    }
}

// Update user UI after login
function updateUserUI(user) {
    try {
        const avatarUrl = user[5] || `https://ui-avatars.com/api/?name=${encodeURIComponent(user[4] || 'User')}&background=e94560&color=fff`;

        // Update avatar
        const userAvatar = document.getElementById('userAvatar');
        if (userAvatar) userAvatar.src = avatarUrl;

        // Update username
        const usernameEl = document.getElementById('userName');
        if (usernameEl) usernameEl.textContent = user[4] || 'User';

        // Update level
        const levelEl = document.getElementById('userLevel');
        if (levelEl) levelEl.textContent = user[6] || '1';

        // Update balance
        updateBalance();
    } catch (error) {
        console.error('Error updating user UI:', error);
    }
}

// Logout function
function logout() {
    try {
        if (currentUser) {
            // If it's a Google user, remove Google data too
            if (currentUser[7]) { // Google ID exists
                localStorage.removeItem('buxiq_google_user');
            }
        }

        currentUser = null;
        localStorage.removeItem('buxiq_account');

        document.getElementById('dashboard')?.classList.add('hidden');
        document.getElementById('login-container')?.classList.remove('hidden');
        document.getElementById('login-account').value = '';
        document.getElementById('login-clientid').value = '';
        document.getElementById('captchaInput').value = '';

        const errorMsg = document.getElementById('error-msg');
        if (errorMsg) errorMsg.classList.add('hidden');

        generateCaptcha();
        showSection('earn'); // Return to default 'earn' section on logout

        // Reset user info display
        const userAvatar = document.getElementById('userAvatar');
        const usernameEl = document.getElementById('userName');
        const levelEl = document.getElementById('userLevel');
        const balanceEl = document.getElementById('userBalance');
        
        if (userAvatar) userAvatar.src = 'https://ui-avatars.com/api/?background=e94560&color=fff&name=Guest&bold=true';
        if (usernameEl) usernameEl.textContent = 'Guest User';
        if (levelEl) levelEl.textContent = '0';
        if (balanceEl) balanceEl.textContent = '$0.00';
        
        addToLogs('You have been logged out.');
    } catch (error) {
        console.error('Error during logout:', error);
    }
}

// Generate CAPTCHA
function generateCaptcha() {
    try {
        captchaCode = Math.floor(10000 + Math.random() * 90000).toString();
        const captchaEl = document.getElementById('captcha');
        if (captchaEl) {
            captchaEl.textContent = captchaCode;
        }
        return captchaCode;
    } catch (error) {
        console.error('Error generating CAPTCHA:', error);
        return '12345'; // Fallback CAPTCHA
    }
}

// Navigation handler
function showSection(section) {
    try {
        const sections = ['earn', 'shop', 'leaders', 'profile', 'bonus', 'help'];
        sections.forEach(sec => {
            const sectionEl = document.getElementById('section-' + sec);
            if (sectionEl) {
                sectionEl.classList.toggle('hidden', sec !== section);
            }
        });
    } catch (error) {
        console.error('Error showing section:', error);
    }
}

// Update balance function (can be called separately to refresh)
async function updateBalance() {
    try {
        if (!currentUser) {
            console.warn('Cannot update balance: no current user.');
            return;
        }

        const response = await fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vQHuo-I6k4RbAnXvz_FvCzshqg7Cm5dqAXwNkvDLpgpZH84OGUSbX6TiOUfMrCHv3CiNnLnx0IhzNZC/pub?gid=0&single=true&output=csv');
        if (!response.ok) throw new Error('Network error');

        const data = await response.text();
        const rows = data.trim().split('\n').map(r => r.split(','));
        // Find user by account and clientid for accuracy
        const user = rows.find(r => r[0] === currentUser[0] && r[1] === currentUser[1]);

        const balanceEl = document.getElementById('userBalance');
        const levelEl = document.getElementById('userLevel');

        if (user) {
            // Fix NaN issue by ensuring we have a valid number
            const balance = parseFloat(user[3] || '0');
            if (!isNaN(balance)) {
                if (balanceEl) balanceEl.textContent = `$${balance.toFixed(2)}`;
            } else {
                if (balanceEl) balanceEl.textContent = '$0.00';
            }
            
            // Update level
            if (levelEl) levelEl.textContent = user[6] || '1';
            
            // Update currentUser with latest data
            currentUser = user;
        } else {
            // If user not found (e.g., after logout), reset balance display to 0
            if (balanceEl) balanceEl.textContent = '$0.00';
            if (levelEl) levelEl.textContent = '0';
        }
    } catch (err) {
        console.error('Error updating balance:', err);
    }
}

// Fetch CSV for activity logs
async function fetchCSV() {
    try {
        const response = await fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vQ3p3daAnCETfJtrUUvaiNqoUreYkn9FIHus6rEyq-e8E8oLaV51L_NrVWjHp1CyTv3UqBqryq3aH-0/pub?gid=0&single=true&output=csv');
        if (!response.ok) throw new Error('Network error');

        const data = await response.text();
        const rows = data.trim().split('\n').slice(1); // skip header
        const logsContainer = document.getElementById('logs');

        if (!logsContainer) return;
        
        // Clear existing logs except the initial message
        const initialMessage = logsContainer.querySelector('.wm-list-item');
        logsContainer.innerHTML = '';
        if (initialMessage && rows.length === 0) {
            logsContainer.appendChild(initialMessage);
        }

        let hasLogs = false;
        rows.forEach((row, index) => {
            const cols = row.split(',').map(c => c.trim());
            // Ensure necessary columns exist and are not empty
            if (cols.length >= 7 && cols[2] && cols[6]) {
                hasLogs = true;
                const username = cols[2];
                const amount = parseFloat(cols[6]).toFixed(2); // Format amount to 2 decimal places
                const logDiv = document.createElement('div');
                logDiv.className = 'wm-list-item';
                logDiv.innerHTML = `
                    <div class="icon"><i class="fas fa-user"></i></div>
                    <div>${username} earned $${amount}</div>
                `;
                logsContainer.appendChild(logDiv);
            }
        });

        if (!hasLogs && initialMessage) {
            // Keep the initial message if no logs
        }
    } catch (err) {
        console.error('Error fetching activity logs:', err);
        const logsContainer = document.getElementById('logs');
        if (logsContainer) {
            logsContainer.innerHTML = '<div class="wm-list-item"><div class="icon"><i class="fas fa-exclamation-triangle"></i></div><div>Error loading activity logs.</div></div>';
        }
    }
}

// Load leaderboard from CSV
async function loadLeaderboard() {
    try {
        const response = await fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vQHuo-I6k4RbAnXvz_FvCzshqg7Cm5dqAXwNkvDLpgpZH84OGUSbX6TiOUfMrCHv3CiNnLnx0IhzNZC/pub?gid=0&single=true&output=csv');
        if (!response.ok) throw new Error('Network error');

        const data = await response.text();
        const rows = data.trim().split('\n').slice(1); // skip header
        
        // Sort users by balance (descending)
        const users = rows.map(row => {
            const cols = row.split(',');
            return {
                username: cols[4] || 'Unknown',
                balance: parseFloat(cols[3] || 0),
                level: cols[6] || '1'
            };
        }).sort((a, b) => b.balance - a.balance).slice(0, 10); // Top 10 users
        
        const leaderboardBody = document.getElementById('leaderboardBody');
        if (!leaderboardBody) return;
        
        leaderboardBody.innerHTML = '';
        
        users.forEach((user, index) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${index + 1}</td>
                <td>${user.username}</td>
                <td>$${user.balance.toFixed(2)}</td>
                <td>${user.level}</td>
            `;
            leaderboardBody.appendChild(row);
        });
    } catch (err) {
        console.error('Error loading leaderboard:', err);
    }
}

// Helper function to add messages to logs
function addToLogs(message) {
    const logsContainer = document.getElementById('logs');
    const logEntry = document.createElement('div');
    logEntry.className = 'wm-list-item';
    logEntry.innerHTML = `
        <div class="icon"><i class="fas fa-info-circle"></i></div>
        <div>${new Date().toLocaleTimeString()} - ${message}</div>
    `;
    
    // Remove initial placeholder if it exists
    const initialMessage = logsContainer.querySelector('.wm-list-item:first-child');
    if (initialMessage && initialMessage.textContent.includes('activity log will appear here')) {
        logsContainer.removeChild(initialMessage);
    }
    
    logsContainer.appendChild(logEntry);
    logsContainer.scrollTop = logsContainer.scrollHeight;
}

// Bonus Code Redemption
async function redeemBonusCode() {
    const username = document.getElementById('username')?.value?.trim();
    const bonusCode = document.getElementById('bonusCode')?.value?.trim();
    
    if (!username || !bonusCode) {
        alert('Please fill in all fields');
        return;
    }
    
    try {
        // Send a request to the Google Apps Script web app to fetch data from the Google Sheets
        const response = await fetch(`https://script.google.com/macros/s/AKfycbxmqOnPJLPuHD6u_DD66bwY0R4MYQ8v9uF1Mv0pm8Sg9APSS4R4oXzbs3zin2FoTMK5/exec?username=${username}&bonusCode=${bonusCode}`);
        const result = await response.text();

        console.log('Bonus redemption result:', result); // For debugging

        if (result.includes("Error")) {
            alert(result);
        } else {
            const [amountLocal, amountUsd] = result.split(','); // Expecting data in format "amountLocal,amountUsd"
            document.getElementById('amountLocal').value = amountLocal;
            document.getElementById('amountUsd').value = amountUsd;
            sendPostback(amountLocal, amountUsd, username, bonusCode); // Call the postback function
            alert('Bonus code redeemed successfully!');
        }
    } catch (error) {
        console.error('Error redeeming bonus code:', error);
        alert('Error redeeming bonus code. Please try again.');
    }
}

// Postback Function
function sendPostback(amountLocal, amountUsd, username, bonusCode) {
    const timestamp = new Date().getTime();
    const postbackUrl = `https://script.google.com/macros/s/AKfycbyvw4LiShTvgnTTLRLISnTYJRhqeStmZgL9YD_ZuQEJubcDPH8bSbGpHPCVHDfx0dbW/exec?status=success&trans_id=${timestamp}&user_id=${username}&bonusCode=${bonusCode}&sub_id=&sub_id_2=&amount_local=${amountLocal}&amount_usd=${amountUsd}&offer_id=offer001&hash=secure_hash_value&ip_click=192.168.1.1`;

    fetch(postbackUrl)
        .then(response => response.json())
        .then(data => console.log('Postback Success:', data))
        .catch(error => console.error('Postback Error:', error));
}
    </script>
</body>
</html>
